{% extends "base.html" %}
{% load static %}

{% block title %}Purchase History - Xanula{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8 max-w-4xl">
    <!-- Header -->
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-white mb-2">Purchase History</h1>
        <p class="text-gray-400">View all your book purchases</p>
    </div>

    <!-- Filter Tabs -->
    <div class="flex flex-wrap gap-2 mb-6 border-b border-gray-800 pb-4">
        <a href="?status=all"
            class="px-4 py-2 rounded-lg text-sm font-medium transition-colors {% if status_filter == 'all' %}bg-primary-500 text-white{% else %}bg-dark-200 text-gray-400 hover:text-white{% endif %}">
            All ({{ status_counts.all }})
        </a>
        <a href="?status=completed"
            class="px-4 py-2 rounded-lg text-sm font-medium transition-colors {% if status_filter == 'completed' %}bg-green-500 text-white{% else %}bg-dark-200 text-gray-400 hover:text-white{% endif %}">
            Completed ({{ status_counts.completed }})
        </a>
        <a href="?status=pending"
            class="px-4 py-2 rounded-lg text-sm font-medium transition-colors {% if status_filter == 'pending' %}bg-yellow-500 text-white{% else %}bg-dark-200 text-gray-400 hover:text-white{% endif %}">
            Pending ({{ status_counts.pending }})
        </a>
        <a href="?status=failed"
            class="px-4 py-2 rounded-lg text-sm font-medium transition-colors {% if status_filter == 'failed' %}bg-red-500 text-white{% else %}bg-dark-200 text-gray-400 hover:text-white{% endif %}">
            Failed ({{ status_counts.failed }})
        </a>
    </div>

    <!-- Purchases List -->
    {% if page_obj %}
    <div class="space-y-4">
        {% for purchase in page_obj %}
        <div class="bg-dark-200 border border-gray-800 rounded-xl p-4 hover:border-gray-700 transition-colors">
            <div class="flex gap-4">
                <!-- Book Cover -->
                <a href="{{ purchase.book.get_absolute_url }}" class="w-16 h-24 flex-shrink-0 rounded-lg overflow-hidden">
                    {% if purchase.book.cover_image %}
                    <img src="{{ purchase.book.cover_image.url }}" alt="{{ purchase.book.title }}" class="w-full h-full object-cover">
                    {% else %}
                    <div class="w-full h-full bg-gradient-to-br from-primary-700 to-secondary-700 flex items-center justify-center">
                        <span class="text-lg font-bold text-white/50">{{ purchase.book.title|first }}</span>
                    </div>
                    {% endif %}
                </a>

                <!-- Purchase Info -->
                <div class="flex-1 min-w-0">
                    <div class="flex items-start justify-between gap-2 mb-1">
                        <a href="{{ purchase.book.get_absolute_url }}" class="font-semibold text-white hover:text-primary-400 truncate">
                            {{ purchase.book.title }}
                        </a>
                        <!-- Status Badge -->
                        {% if purchase.payment_status == 'completed' %}
                        <span class="px-2 py-1 text-xs font-medium bg-green-500/20 text-green-400 rounded-full whitespace-nowrap">Completed</span>
                        {% elif purchase.payment_status == 'pending' %}
                        <span class="px-2 py-1 text-xs font-medium bg-yellow-500/20 text-yellow-400 rounded-full whitespace-nowrap">Pending</span>
                        {% elif purchase.payment_status == 'failed' %}
                        <span class="px-2 py-1 text-xs font-medium bg-red-500/20 text-red-400 rounded-full whitespace-nowrap">Failed</span>
                        {% elif purchase.payment_status == 'refunded' %}
                        <span class="px-2 py-1 text-xs font-medium bg-gray-500/20 text-gray-400 rounded-full whitespace-nowrap">Refunded</span>
                        {% endif %}
                    </div>
                    
                    <p class="text-sm text-gray-400 mb-2">by {{ purchase.book.author.get_full_name }}</p>

                    <div class="flex flex-wrap gap-4 text-sm">
                        <span class="text-gray-400">
                            {% if purchase.amount_paid == 0 %}
                            <span class="text-green-400 font-medium">Free</span>
                            {% else %}
                            <span class="text-white font-medium">{{ purchase.amount_paid|floatformat:0 }} XAF</span>
                            {% endif %}
                        </span>
                        <span class="text-gray-500">{{ purchase.get_payment_method_display }}</span>
                        <span class="text-gray-500">{{ purchase.purchase_date|date:"M d, Y" }}</span>
                    </div>

                    {% if purchase.payment_transaction_id and purchase.payment_transaction_id != 'FREE' %}
                    <p class="text-xs text-gray-600 mt-2 font-mono">
                        ID: {{ purchase.payment_transaction_id|truncatechars:25 }}
                    </p>
                    {% endif %}

                    {% if purchase.payment_status == 'completed' %}
                    <div class="mt-3">
                        <a href="{% url 'core:my_books' %}" class="text-sm text-primary-400 hover:text-primary-300">
                            View in Library â†’
                        </a>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Pagination -->
    {% if page_obj.has_other_pages %}
    <div class="flex justify-center gap-2 mt-8">
        {% if page_obj.has_previous %}
        <a href="?status={{ status_filter }}&page={{ page_obj.previous_page_number }}"
            class="px-4 py-2 bg-dark-200 text-gray-300 rounded-lg hover:bg-dark-100">
            Previous
        </a>
        {% endif %}
        
        <span class="px-4 py-2 text-gray-400">
            Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}
        </span>
        
        {% if page_obj.has_next %}
        <a href="?status={{ status_filter }}&page={{ page_obj.next_page_number }}"
            class="px-4 py-2 bg-dark-200 text-gray-300 rounded-lg hover:bg-dark-100">
            Next
        </a>
        {% endif %}
    </div>
    {% endif %}

    {% else %}
    <!-- Empty State -->
    <div class="text-center py-16 bg-dark-200 border border-gray-800 rounded-xl">
        <svg class="w-16 h-16 mx-auto text-gray-600 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" />
        </svg>
        <h3 class="text-xl font-semibold text-white mb-2">No purchases yet</h3>
        <p class="text-gray-400 mb-6">Start exploring our collection of books!</p>
        <a href="{% url 'core:book_list' %}" class="inline-block px-6 py-3 bg-gradient-to-r from-primary-500 to-secondary-500 text-white font-semibold rounded-lg hover:from-primary-600 hover:to-secondary-600 transition-all">
            Browse Books
        </a>
    </div>
    {% endif %}
</div>
{% endblock %}
