{% extends "base.html" %}
{% load static %}

{% block title %}Processing Payment - Xanula{% endblock %}

{% block content %}
<div class="container py-12 max-w-lg mx-auto text-center" x-data="paymentPoller()">
    <!-- Processing State -->
    <div class="mb-8">
        <div class="w-20 h-20 bg-gold-100 dark:bg-gold-900/30 rounded-full flex items-center justify-center mx-auto mb-6">
            <svg class="w-10 h-10 text-gold-500 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
            </svg>
        </div>
        <h1 class="font-display text-3xl font-bold text-gray-900 dark:text-white mb-2">Processing Payment</h1>
        <p class="text-gray-600 dark:text-gray-400" x-text="statusMessage">Waiting for mobile money confirmation...</p>
    </div>

    <!-- Book Info -->
    <div class="bg-white dark:bg-dark-100 border border-gray-200 dark:border-gray-700 rounded-2xl p-6 mb-8">
        <div class="flex items-center gap-4">
            <div class="w-14 h-20 flex-shrink-0 rounded-lg overflow-hidden shadow">
                {% if book.cover_image %}
                <img src="{{ book.cover_image.url }}" alt="{{ book.title }}" class="w-full h-full object-cover" width="56" height="80">
                {% else %}
                <div class="w-full h-full bg-gradient-to-br from-burgundy-500 to-forest-500 flex items-center justify-center">
                    <span class="font-display font-bold text-white/40">{{ book.title|first }}</span>
                </div>
                {% endif %}
            </div>
            <div class="text-left">
                <h3 class="font-display font-semibold text-gray-900 dark:text-white">{{ book.title }}</h3>
                <p class="text-sm text-burgundy-500 font-medium">{{ purchase.amount_paid|floatformat:0 }} XAF</p>
            </div>
        </div>
    </div>

    <!-- Progress -->
    <div class="mb-8">
        <div class="flex items-center justify-center gap-2 text-sm text-gray-500 mb-4">
            <span class="animate-pulse">‚è≥</span>
            <span>This usually takes 1-2 minutes</span>
        </div>
        
        <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2">
            <div class="bg-gold-500 h-2 rounded-full transition-all duration-500" :style="'width: ' + progressPercent + '%'"></div>
        </div>
        
        <p class="text-xs text-gray-500 mt-2">Checking every 3 seconds... (<span x-text="pollCount"></span> checks)</p>
    </div>

    <!-- Timeout -->
    <div x-show="timedOut" x-cloak class="bg-gold-50 dark:bg-gold-900/20 border border-gold-200 dark:border-gold-800 rounded-2xl p-6 mb-6">
        <p class="text-gold-600 dark:text-gold-400 mb-4">Payment is taking longer than expected.</p>
        <div class="flex flex-col sm:flex-row gap-3 justify-center">
            <button @click="resetPolling()" class="btn bg-gold-500 hover:bg-gold-600 text-white">Keep Waiting</button>
            <a href="{% url 'core:book_detail' slug=book.slug %}" class="btn btn-secondary">Try Again Later</a>
        </div>
    </div>

    <!-- Error -->
    <div x-show="hasFailed" x-cloak class="bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-2xl p-6 mb-6">
        <p class="text-red-600 dark:text-red-400 mb-4" x-text="errorMessage">Payment failed.</p>
        <a href="{{ book.get_absolute_url }}" class="btn btn-primary">Try Again</a>
    </div>

    <!-- Tips -->
    <div class="text-left bg-cream dark:bg-dark-50 border border-gray-200 dark:border-gray-700 rounded-2xl p-4" x-show="!timedOut && !hasFailed">
        <p class="text-sm text-gray-700 dark:text-gray-300 mb-3"><strong>While you wait:</strong></p>
        <ul class="text-sm text-gray-600 dark:text-gray-400 space-y-2">
            <li class="flex items-start gap-2"><span>üì±</span> Check your phone for a confirmation prompt</li>
            <li class="flex items-start gap-2"><span>‚úÖ</span> Approve the payment on your mobile money app</li>
            <li class="flex items-start gap-2"><span>‚è≥</span> This page will update automatically</li>
        </ul>
    </div>
</div>

<script>
function paymentPoller() {
    return {
        purchaseId: {{ purchase.id }},
        pollCount: 0,
        maxPolls: 40,
        progressPercent: 0,
        statusMessage: 'Waiting for mobile money confirmation...',
        timedOut: false,
        hasFailed: false,
        errorMessage: '',
        pollInterval: null,
        
        init() { this.startPolling(); },
        startPolling() { this.pollInterval = setInterval(() => this.checkStatus(), 3000); },
        stopPolling() { if (this.pollInterval) { clearInterval(this.pollInterval); this.pollInterval = null; } },
        resetPolling() { this.pollCount = 0; this.timedOut = false; this.progressPercent = 0; this.startPolling(); },
        
        async checkStatus() {
            this.pollCount++;
            this.progressPercent = Math.min((this.pollCount / this.maxPolls) * 100, 100);
            if (this.pollCount >= this.maxPolls) { this.timedOut = true; this.stopPolling(); return; }
            
            try {
                const response = await fetch(`/api/check-purchase-status/${this.purchaseId}/`, { headers: { 'X-Requested-With': 'XMLHttpRequest' }});
                const data = await response.json();
                
                if (data.status === 'completed') {
                    this.stopPolling();
                    this.statusMessage = 'Payment successful! Redirecting...';
                    setTimeout(() => { window.location.href = data.redirect_url || '/library/'; }, 1500);
                } else if (data.status === 'failed') {
                    this.stopPolling();
                    this.hasFailed = true;
                    this.errorMessage = data.message || 'Payment failed.';
                } else {
                    this.statusMessage = data.message || 'Processing...';
                }
            } catch (error) {
                console.error('Status check failed:', error);
                this.statusMessage = 'Checking payment status...';
            }
        }
    }
}
</script>
{% endblock %}
