<!DOCTYPE html>
<html lang="en" x-data="{ darkMode: localStorage.getItem('theme') === 'dark' }" :class="darkMode ? 'dark' : ''">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" :content="darkMode ? '#1A1915' : '#FAF7F2'">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>{{ book.title }} - Xanula Audio</title>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;500;600;700&family=Source+Sans+Pro:wght@400;600;700&display=swap" rel="stylesheet">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        burgundy: { 50: '#fdf2f4', 100: '#fce7ea', 400: '#C45C6A', 500: '#8B2635', 600: '#7A2130' },
                        forest: { 50: '#f0f5f1', 400: '#5A8B6F', 500: '#2D4739' },
                        gold: { 400: '#E8C59E', 500: '#D4A574' },
                        cream: '#FAF7F2',
                        dark: { 50: '#252420', 100: '#1A1915', 200: '#141310' }
                    },
                    fontFamily: {
                        display: ['Playfair Display', 'serif'],
                        sans: ['Source Sans Pro', 'sans-serif']
                    }
                }
            }
        }
    </script>
    
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
    
    <style>
        [x-cloak] { display: none !important; }
        * { -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Source Sans Pro', sans-serif; }
        
        /* 3D Book Cover Styling */
        .book-3d {
            perspective: 1000px;
        }
        
        .book-cover {
            position: relative;
            transform-style: preserve-3d;
            transform: rotateY(-8deg);
            transition: transform 0.4s ease;
        }
        
        .book-cover:hover {
            transform: rotateY(-2deg);
        }
        
        /* Floating animation when playing */
        @keyframes bookFloat {
            0%, 100% { transform: rotateY(-8deg) translateY(0px); }
            50% { transform: rotateY(-8deg) translateY(-8px); }
        }
        
        .book-cover.is-playing {
            animation: bookFloat 3s ease-in-out infinite;
        }
        
        .book-cover.is-playing:hover {
            animation-play-state: paused;
            transform: rotateY(-2deg);
        }
        
        /* Book spine (left edge) */
        .book-spine {
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 20px;
            background: linear-gradient(to right, 
                rgba(0,0,0,0.3) 0%, 
                rgba(0,0,0,0.1) 30%,
                rgba(255,255,255,0.1) 50%,
                rgba(0,0,0,0.05) 100%);
            border-radius: 2px 0 0 2px;
            transform: translateZ(2px);
        }
        
        /* Book pages peek (right edge) */
        .book-pages {
            position: absolute;
            right: -6px;
            top: 3px;
            bottom: 3px;
            width: 6px;
            background: linear-gradient(to right,
                #e8e4dc 0%,
                #f5f2ea 20%,
                #e0dcd4 40%,
                #f5f2ea 60%,
                #e8e4dc 80%,
                #d8d4cc 100%);
            border-radius: 0 1px 1px 0;
            transform: translateZ(-2px);
        }
        
        .dark .book-pages {
            background: linear-gradient(to right,
                #3a3830 0%,
                #4a483e 20%,
                #3a3830 40%,
                #4a483e 60%,
                #3a3830 80%,
                #2a2820 100%);
        }
        
        /* Cover image container */
        .book-front {
            position: relative;
            border-radius: 2px 4px 4px 2px;
            overflow: hidden;
            box-shadow: 
                4px 4px 12px rgba(0,0,0,0.2),
                8px 8px 25px rgba(0,0,0,0.15),
                inset -2px 0 8px rgba(0,0,0,0.1);
        }
        
        .dark .book-front {
            box-shadow: 
                4px 4px 15px rgba(0,0,0,0.4),
                8px 8px 30px rgba(0,0,0,0.3),
                inset -2px 0 8px rgba(0,0,0,0.2);
        }
        
        /* Wave Progress */
        .wave-progress-wrap {
            width: 100%;
            height: 36px;
            cursor: pointer;
            position: relative;
            border-radius: 8px;
            overflow: hidden;
        }
        .wave-progress-wrap canvas {
            width: 100%;
            height: 100%;
            display: block;
        }
        
        /* Playing indicator */
        .audio-dot {
            animation: pulse 1.5s ease-in-out infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 0.4; }
            50% { opacity: 1; }
        }
        
        /* Safe areas */
        .safe-area-top { padding-top: max(12px, env(safe-area-inset-top)); }
        .safe-area-bottom { padding-bottom: max(16px, env(safe-area-inset-bottom)); }
    </style>
</head>
<body class="bg-cream dark:bg-dark-100 text-gray-900 dark:text-white min-h-screen transition-colors" x-data="audioPlayer()">
    
    <!-- Loading -->
    <div x-show="loading" x-cloak class="fixed inset-0 z-50 flex items-center justify-center bg-cream dark:bg-dark-100">
        <div class="text-center">
            <div class="w-12 h-12 mx-auto mb-4 border-2 border-burgundy-500/30 border-t-burgundy-500 rounded-full animate-spin"></div>
            <p class="text-gray-500 dark:text-gray-400">Loading audiobook...</p>
        </div>
    </div>
    
    <!-- Error -->
    <div x-show="error" x-cloak class="fixed inset-0 z-50 flex items-center justify-center bg-cream dark:bg-dark-100 p-6">
        <div class="text-center max-w-sm">
            <div class="w-16 h-16 mx-auto mb-4 rounded-xl bg-burgundy-500/10 flex items-center justify-center">
                <span class="text-3xl">ðŸ“•</span>
            </div>
            <h2 class="font-display text-xl font-semibold text-gray-900 dark:text-cream mb-2">Unable to Load</h2>
            <p class="text-gray-500 dark:text-gray-400 text-sm mb-6" x-text="errorMessage"></p>
            <div class="flex gap-3 justify-center">
                <button @click="retryLoad()" class="px-5 py-2 bg-burgundy-500 text-white text-sm font-semibold rounded-lg">Retry</button>
                <a href="{% url 'core:library' %}" class="px-5 py-2 bg-gray-200 dark:bg-dark-50 text-gray-900 dark:text-cream text-sm font-semibold rounded-lg">Library</a>
            </div>
        </div>
    </div>
    
    <!-- Main Layout -->
    <div class="min-h-screen flex flex-col">
        
        <!-- Header -->
        <header class="fixed top-0 left-0 right-0 z-40 bg-cream/90 dark:bg-dark-100/90 backdrop-blur-lg border-b border-gray-200 dark:border-white/5 safe-area-top">
            <div class="flex items-center justify-between px-4 py-3 max-w-lg mx-auto">
                <a href="{% url 'core:library' %}" class="p-2 -ml-2 rounded-lg hover:bg-gray-100 dark:hover:bg-white/5">
                    <svg class="w-5 h-5 text-gray-500 dark:text-cream/60" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                    </svg>
                </a>
                
                <!-- Playing Indicator -->
                <div x-show="isPlaying && !loading" class="flex items-center gap-2 text-xs text-burgundy-500 font-medium">
                    <span class="w-2 h-2 rounded-full bg-burgundy-500 audio-dot"></span>
                    Powered by REEPLS
                </div>
                <div x-show="!isPlaying || loading" class="text-xs text-gray-400 dark:text-cream/40 font-medium">Xanula</div>
                
                <!-- Speed -->
                <button @click="showSpeedMenu = !showSpeedMenu" class="px-2.5 py-1 rounded-md bg-gray-100 dark:bg-white/5 text-xs font-semibold text-gray-600 dark:text-cream/70 hover:bg-gray-200 dark:hover:bg-white/10">
                    <span x-text="playbackSpeed + 'Ã—'"></span>
                </button>
            </div>
        </header>
        
        <!-- Speed Menu -->
        <div x-show="showSpeedMenu" x-cloak @click.away="showSpeedMenu = false"
            x-transition:enter="transition ease-out duration-150"
            x-transition:enter-start="opacity-0 scale-95"
            x-transition:enter-end="opacity-100 scale-100"
            class="fixed top-14 right-4 z-50 w-40 bg-white dark:bg-dark-50 rounded-xl shadow-xl border border-gray-200 dark:border-white/10 p-1.5">
            <template x-for="speed in [0.75, 1, 1.25, 1.5, 2]" :key="speed">
                <button @click="setSpeed(speed)" 
                    :class="playbackSpeed === speed ? 'bg-burgundy-500 text-white' : 'text-gray-700 dark:text-cream/70 hover:bg-gray-100 dark:hover:bg-white/5'" 
                    class="w-full px-3 py-2 text-left text-sm rounded-lg font-medium"
                    x-text="speed + 'Ã—'"></button>
            </template>
        </div>
        
        <!-- Sleep Timer Menu -->
        <div x-show="showSleepMenu" x-cloak @click.away="showSleepMenu = false"
            x-transition:enter="transition ease-out duration-150"
            class="fixed inset-x-4 bottom-40 z-50 max-w-xs mx-auto bg-white dark:bg-dark-50 rounded-2xl shadow-xl border border-gray-200 dark:border-white/10 p-4">
            <p class="text-center text-sm font-semibold text-gray-900 dark:text-cream mb-3">Sleep Timer</p>
            <div class="grid grid-cols-3 gap-2">
                <template x-for="mins in [15, 30, 45, 60]" :key="mins">
                    <button @click="setSleepTimer(mins)" 
                        class="py-2.5 rounded-lg text-sm font-medium text-gray-600 dark:text-cream/70 bg-gray-100 dark:bg-white/5 hover:bg-burgundy-500 hover:text-white transition-colors"
                        x-text="mins + 'm'"></button>
                </template>
            </div>
            <button @click="cancelSleepTimer()" x-show="sleepTimerActive" class="w-full mt-2 py-2 text-sm text-burgundy-500 hover:bg-burgundy-50 dark:hover:bg-burgundy-500/10 rounded-lg">Cancel</button>
        </div>
        
        <!-- Cover & Info -->
        <main class="flex-1 flex flex-col items-center justify-center px-6 pt-20 pb-48">
            
            <!-- 3D Book Cover -->
            <div class="mb-8 book-3d">
                <div class="book-cover relative" :class="isPlaying ? 'is-playing' : ''">
                    <!-- Pages edge (right side) -->
                    <div class="book-pages"></div>
                    
                    <!-- Main book cover (bigger: w-52 h-72 / w-60 h-88) -->
                    <div class="book-front w-52 h-72 sm:w-60 sm:h-[22rem]">
                        <!-- Spine highlight (left edge) -->
                        <div class="book-spine"></div>
                        
                        {% if cover_url %}
                        <img src="{{ cover_url }}" alt="{{ book.title }}" class="w-full h-full object-cover">
                        {% else %}
                        <div class="w-full h-full bg-gradient-to-br from-burgundy-500 to-forest-500 flex items-center justify-center">
                            <span class="font-display text-5xl text-white/30">{{ book.title|first }}</span>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <!-- Book Info -->
            <div class="text-center max-w-sm">
                <h1 class="font-display text-xl sm:text-2xl font-semibold text-gray-900 dark:text-cream mb-1 leading-snug">{{ book.title }}</h1>
                <p class="text-gray-500 dark:text-cream/50">{{ book.author.get_display_name }}</p>
                
                <!-- Sleep Timer Badge -->
                <div x-show="sleepTimerActive" x-cloak class="inline-flex items-center gap-1.5 mt-4 px-3 py-1 rounded-full bg-forest-50 dark:bg-forest-500/20 text-forest-500 dark:text-forest-400 text-xs font-medium">
                    <span>ðŸŒ™</span>
                    <span x-text="sleepTimerDisplay"></span>
                </div>
            </div>
        </main>
        
        <!-- Player Controls -->
        <footer class="fixed bottom-0 left-0 right-0 z-40 bg-white/95 dark:bg-dark-200/95 backdrop-blur-lg border-t border-gray-200 dark:border-white/5 safe-area-bottom">
            <div class="max-w-lg mx-auto px-5 py-4">
                
                <!-- Progress (Sine Wave) -->
                <div class="mb-4">
                    <div class="wave-progress-wrap" id="audiobook-wave" @click="waveSeek($event)"></div>
                    <div class="flex justify-between mt-1.5 text-xs text-gray-400 dark:text-cream/40 font-medium">
                        <span x-text="formatTime(currentTime)"></span>
                        <span x-text="formatTime(duration)"></span>
                    </div>
                </div>
                
                <!-- Controls Row -->
                <div class="flex items-center justify-between">
                    <!-- Left: Volume -->
                    <button @click="toggleMute()" class="p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-white/5">
                        <svg x-show="!isMuted && volume > 0" class="w-5 h-5 text-gray-400 dark:text-cream/50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z"/>
                        </svg>
                        <svg x-show="isMuted || volume === 0" x-cloak class="w-5 h-5 text-burgundy-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15zM17 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2"/>
                        </svg>
                    </button>
                    
                    <!-- Center: Main Controls -->
                    <div class="flex items-center gap-3">
                        <button @click="skipBack()" class="p-2 active:scale-95 transition-transform">
                            <svg class="w-7 h-7 text-gray-500 dark:text-cream/70" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12.066 11.2a1 1 0 000 1.6l5.334 4A1 1 0 0019 16V8a1 1 0 00-1.6-.8l-5.333 4zM4.066 11.2a1 1 0 000 1.6l5.334 4A1 1 0 0011 16V8a1 1 0 00-1.6-.8l-5.334 4z"/>
                            </svg>
                        </button>
                        
                        <button @click="togglePlay()" class="p-4 rounded-full bg-burgundy-500 hover:bg-burgundy-600 active:scale-95 transition-all">
                            <svg x-show="!isPlaying" class="w-7 h-7 text-white ml-0.5" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M8 5v14l11-7z"/>
                            </svg>
                            <svg x-show="isPlaying" x-cloak class="w-7 h-7 text-white" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M6 4h4v16H6V4zm8 0h4v16h-4V4z"/>
                            </svg>
                        </button>
                        
                        <button @click="skipForward()" class="p-2 active:scale-95 transition-transform">
                            <svg class="w-7 h-7 text-gray-500 dark:text-cream/70" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M11.933 12.8a1 1 0 000-1.6L6.6 7.2A1 1 0 005 8v8a1 1 0 001.6.8l5.333-4zM19.933 12.8a1 1 0 000-1.6l-5.333-4A1 1 0 0013 8v8a1 1 0 001.6.8l5.333-4z"/>
                            </svg>
                        </button>
                    </div>
                    
                    <!-- Right: Sleep Timer -->
                    <button @click="showSleepMenu = true" class="p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-white/5" :class="sleepTimerActive ? 'text-forest-500' : 'text-gray-400 dark:text-cream/50'">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"/>
                        </svg>
                    </button>
                </div>
            </div>
        </footer>
    </div>
    
    <!-- Audio -->
    <audio x-ref="audio" preload="auto" @loadedmetadata="onMetadataLoaded()" @timeupdate="onTimeUpdate()" 
        @play="isPlaying = true" @pause="isPlaying = false" @waiting="isBuffering = true" @playing="isBuffering = false"
        @ended="onEnded()" @error="onError($event)">
        <source src="{{ audiobook_url }}" type="audio/mpeg">
    </audio>
    
    <script>
        function audioPlayer() {
            return {
                loading: true, error: false, errorMessage: '', isPlaying: false, isBuffering: false, isMuted: false,
                audio: null, currentTime: 0, duration: 0, progressPercent: 0,
                volume: parseFloat(localStorage.getItem('audio-volume') || '1'),
                playbackSpeed: parseFloat(localStorage.getItem('audio-speed') || '1'),
                showSpeedMenu: false, showSleepMenu: false,
                sleepTimerActive: false, sleepTimerEndTime: null, sleepTimerDisplay: '', sleepTimerInterval: null,
                bookId: {{ book.id }}, initialProgress: {{ listening_progress|default:0 }},
                wavePhase: 0, waveAmplitude: 0,
                
                init() {
                    this.audio = this.$refs.audio;
                    this.audio.volume = this.volume;
                    this.audio.playbackRate = this.playbackSpeed;
                    setInterval(() => this.syncProgress(), 30000);
                    setInterval(() => localStorage.setItem(`audiobook-${this.bookId}-progress`, this.currentTime), 10000);
                    this.setupMediaSession();
                    window.addEventListener('beforeunload', () => this.syncProgress());
                    this.initWave();
                },
                
                initWave() {
                    const wrap = document.getElementById('audiobook-wave');
                    if (!wrap) return;
                    const canvas = document.createElement('canvas');
                    wrap.appendChild(canvas);
                    const ctx = canvas.getContext('2d');
                    const self = this;
                    
                    function resize() {
                        const dpr = window.devicePixelRatio || 1;
                        const rect = wrap.getBoundingClientRect();
                        canvas.width = rect.width * dpr;
                        canvas.height = rect.height * dpr;
                        ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
                    }
                    resize();
                    window.addEventListener('resize', resize);
                    
                    const BURGUNDY = '#8B2635';
                    const GRAY = '#d1d5db';
                    const DARK_GRAY = '#4b5563';
                    
                    function draw() {
                        const w = wrap.clientWidth;
                        const h = wrap.clientHeight;
                        const mid = h / 2;
                        
                        // Smooth amplitude
                        const target = self.isPlaying ? 1 : 0;
                        self.waveAmplitude += (target - self.waveAmplitude) * 0.06;
                        
                        ctx.clearRect(0, 0, w, h);
                        
                        const progress = self.duration > 0 ? self.currentTime / self.duration : 0;
                        const playedX = w * progress;
                        const lineW = 2.5;
                        const amp = 3 * self.waveAmplitude;
                        const freq = 0.25;
                        
                        // Played: sine wave
                        ctx.beginPath();
                        ctx.moveTo(0, mid);
                        for (let x = 0; x <= playedX; x += 1) {
                            ctx.lineTo(x, mid + Math.sin(x * freq + self.wavePhase) * amp);
                        }
                        ctx.strokeStyle = BURGUNDY;
                        ctx.lineWidth = lineW;
                        ctx.lineCap = 'round';
                        ctx.lineJoin = 'round';
                        ctx.stroke();
                        
                        // Unplayed: flat line with lerp
                        if (playedX < w) {
                            const isDark = document.documentElement.classList.contains('dark');
                            ctx.beginPath();
                            const startY = playedX > 0 ? mid + Math.sin(playedX * freq + self.wavePhase) * amp : mid;
                            ctx.moveTo(playedX, startY);
                            const lerpEnd = Math.min(playedX + 20, w);
                            for (let x = playedX; x <= lerpEnd; x += 1) {
                                const t = (x - playedX) / 20;
                                ctx.lineTo(x, startY + (mid - startY) * t);
                            }
                            ctx.lineTo(w, mid);
                            ctx.strokeStyle = isDark ? DARK_GRAY : GRAY;
                            ctx.lineWidth = lineW;
                            ctx.lineCap = 'round';
                            ctx.stroke();
                        }
                        
                        // Position dot
                        if (progress > 0 && progress < 1) {
                            const dotY = mid + Math.sin(playedX * freq + self.wavePhase) * amp;
                            ctx.beginPath();
                            ctx.arc(playedX, dotY, 5, 0, Math.PI * 2);
                            ctx.fillStyle = BURGUNDY;
                            ctx.fill();
                            ctx.beginPath();
                            ctx.arc(playedX, dotY, 2, 0, Math.PI * 2);
                            ctx.fillStyle = '#fff';
                            ctx.fill();
                        }
                        
                        if (self.isPlaying) self.wavePhase += 0.1;
                        requestAnimationFrame(draw);
                    }
                    draw();
                },
                
                waveSeek(e) {
                    if (this.duration > 0) {
                        const wrap = document.getElementById('audiobook-wave');
                        const rect = wrap.getBoundingClientRect();
                        const ratio = (e.clientX - rect.left) / rect.width;
                        this.audio.currentTime = ratio * this.duration;
                    }
                },
                
                onMetadataLoaded() {
                    this.duration = this.audio.duration;
                    this.loading = false;
                    const local = parseFloat(localStorage.getItem(`audiobook-${this.bookId}-progress`)) || 0;
                    const dbProgress = this.initialProgress || 0;
                    const resume = Math.max(local, dbProgress);
                    
                    console.log('[Audiobook] Resume check - Local:', local, 'DB:', dbProgress, 'Using:', resume);
                    
                    if (resume > 0 && resume < this.duration) { 
                        this.audio.currentTime = resume; 
                        this.currentTime = resume; 
                    }
                    this.updateProgressPercent();
                },
                
                onTimeUpdate() { this.currentTime = this.audio.currentTime; this.updateProgressPercent(); },
                onEnded() { this.isPlaying = false; this.syncProgress(); },
                onError() { this.loading = false; this.error = true; this.errorMessage = 'Failed to load audio'; },
                retryLoad() { this.error = false; this.loading = true; this.audio.load(); },
                togglePlay() { this.audio.paused ? this.audio.play().catch(e => {}) : this.audio.pause(); },
                skipBack() { this.audio.currentTime = Math.max(0, this.audio.currentTime - 15); },
                skipForward() { this.audio.currentTime = Math.min(this.duration, this.audio.currentTime + 15); },
                seekTo(t) { this.audio.currentTime = parseFloat(t); },
                toggleMute() { this.isMuted = !this.isMuted; this.audio.muted = this.isMuted; },
                setSpeed(s) { this.playbackSpeed = s; this.audio.playbackRate = s; localStorage.setItem('audio-speed', s); this.showSpeedMenu = false; },
                
                setSleepTimer(mins) {
                    this.sleepTimerActive = true;
                    this.sleepTimerEndTime = Date.now() + mins * 60000;
                    this.showSleepMenu = false;
                    if (this.sleepTimerInterval) clearInterval(this.sleepTimerInterval);
                    this.sleepTimerInterval = setInterval(() => {
                        const r = this.sleepTimerEndTime - Date.now();
                        if (r <= 0) { this.audio.pause(); this.cancelSleepTimer(); return; }
                        this.sleepTimerDisplay = Math.floor(r/60000) + ':' + String(Math.floor((r%60000)/1000)).padStart(2,'0');
                    }, 1000);
                },
                cancelSleepTimer() { this.sleepTimerActive = false; if (this.sleepTimerInterval) clearInterval(this.sleepTimerInterval); this.showSleepMenu = false; },
                updateProgressPercent() { if (this.duration > 0) this.progressPercent = (this.currentTime / this.duration) * 100; },
                formatTime(s) { if (isNaN(s)) return '0:00'; const h=Math.floor(s/3600), m=Math.floor((s%3600)/60), sec=Math.floor(s%60); return h>0 ? `${h}:${String(m).padStart(2,'0')}:${String(sec).padStart(2,'0')}` : `${m}:${String(sec).padStart(2,'0')}`; },
                
                setupMediaSession() {
                    if ('mediaSession' in navigator) {
                        navigator.mediaSession.metadata = new MediaMetadata({ title: '{{ book.title|escapejs }}', artist: '{{ book.author.get_display_name|escapejs }}', album: 'Xanula', artwork: [{ src: '{{ cover_url|default:"" }}', sizes: '512x512' }] });
                        navigator.mediaSession.setActionHandler('play', () => this.togglePlay());
                        navigator.mediaSession.setActionHandler('pause', () => this.togglePlay());
                        navigator.mediaSession.setActionHandler('seekbackward', () => this.skipBack());
                        navigator.mediaSession.setActionHandler('seekforward', () => this.skipForward());
                    }
                },
                
                async syncProgress() {
                    try {
                        const response = await fetch('{% url "core:update_listening_progress_api" %}', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-Requested-With': 'XMLHttpRequest',
                                'X-CSRFToken': '{{ csrf_token }}'
                            },
                            body: JSON.stringify({ book_id: this.bookId, current_time: this.currentTime, total_duration: this.duration })
                        });
                        const data = await response.json();
                        console.log('[Audiobook] API sync result:', data);
                    } catch (e) { console.log('[Audiobook] Sync failed - saved locally'); }
                }
            }
        }
    </script>
</body>
</html>
